<!DOCTYPE html>












  


<html class="theme-next gemini use-motion" lang="en">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
























  

<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/font-awesome@4/css/font-awesome.min.css">

<link rel="stylesheet" href="/css/main.css?v=7.1.1">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=7.1.1">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=7.1.1">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=7.1.1">


  <link rel="mask-icon" href="/images/logo.svg?v=7.1.1" color="#222">







<script id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '7.1.1',
    sidebar: {"position":"left","display":"post","offset":12,"onmobile":false,"dimmer":false},
    back2top: true,
    back2top_sidebar: true,
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="Gas is an unit that measures the transaction cost in EVM ecosystem. It is well known that transfers native coin(e.g. VET, ETH) needs 21000 gas to cover the transaction fee, but regarding the contract">
<meta name="keywords" content="dapp,wallet,sdk,gas">
<meta property="og:type" content="article">
<meta property="og:title" content="Gas Estimation">
<meta property="og:url" content="https://blog.outofgas.io/2019/05/20/Gas-Estimation/index.html">
<meta property="og:site_name" content="Insufficient Enerngy">
<meta property="og:description" content="Gas is an unit that measures the transaction cost in EVM ecosystem. It is well known that transfers native coin(e.g. VET, ETH) needs 21000 gas to cover the transaction fee, but regarding the contract">
<meta property="og:locale" content="en">
<meta property="og:updated_time" content="2019-08-14T07:06:32.685Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Gas Estimation">
<meta name="twitter:description" content="Gas is an unit that measures the transaction cost in EVM ecosystem. It is well known that transfers native coin(e.g. VET, ETH) needs 21000 gas to cover the transaction fee, but regarding the contract">





  
  
  <link rel="canonical" href="https://blog.outofgas.io/2019/05/20/Gas-Estimation/">



<script id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>Gas Estimation | Insufficient Enerngy</title>
  




  <script async src="//www.googletagmanager.com/gtag/js?id=UA-142494873-2"></script>
  <script>
    var host = window.location.hostname;
    if (host !== "localhost" || !true) {
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'UA-142494873-2');
    }
  </script>









  <noscript>
  <style>
  .use-motion .motion-element,
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-title { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="en">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Insufficient Enerngy</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="Toggle navigation bar">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">

    
    
    
      
    

    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>Home</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">

    
    
    
      
    

    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>Archives</a>

  </li>

      
      
    </ul>
  

  

  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
            

          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://blog.outofgas.io/2019/05/20/Gas-Estimation/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="tony.li">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Insufficient Enerngy">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Gas Estimation

              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2019-05-20 13:24:06" itemprop="dateCreated datePublished" datetime="2019-05-20T13:24:06+00:00">2019-05-20</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Modified: 2019-08-14 07:06:32" itemprop="dateModified" datetime="2019-08-14T07:06:32+00:00">2019-08-14</time>
              
            
          </span>

          

          
            
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>Gas is an unit that measures the transaction cost in EVM ecosystem. It is well known that transfers native coin(e.g. VET, ETH) needs 21000 gas to cover the transaction fee, but regarding the contract creation and execution, the gas cost is not a fixed value. The gas cost depends on the <code>state</code> on which executed the tx, this is related with EVM’s gas consumption mechanism. One transaction packed in different block could result in different gas cost.</p>
<p>Transaction gas is composed with two parts, <code>Intrinsic Gas</code> and <code>Runtime Gas</code>. The <code>Intrinsic Gas</code> for a transaction is the amount of the transaction used before runtime executes the transaction. </p>
<div class="note default">
            <p><strong>intrinsicGas = txGas + SUM(clause.typeGas + clause.dataGas)</strong></p>
          </div>
<p><code>Intrinsic Gas</code> is deterministic for an transaction while <code>Runtime Gas</code> is dynamic.We have a way to evaluate a transaction’s <code>Runtime Gas</code> by the API <code>POST /accounts/*</code>. As stated above, the evaluated gas just based on the current <code>BestBlock&#39;s State</code>. The gas cost may change when you send the same transaction to the blockchain with the evaluated gas. So the trick is:</p>
<div class="note default">
            <p><strong>You need to increase the evaluated gas before add it to tx gas.</strong></p>
          </div>
<a id="more"></a>
<p>This means differently for different individuals:</p>
<ul>
<li>For <code>DApp Developer</code>: You’d better specify gas for every transaction since you knows everything of your, otherwise you are relying on wallet or SDK to evaluate gas for you.</li>
<li>For <code>Wallet or SDK Developer</code>: if you dev specifies gas, you need to follow it. If not you need evaluate gas for your dev.</li>
</ul>
<p>How much do we increase becomes important. As a contributor to thorify, I increased the evaluated gas by 20% to make sure the transaction won’t run out of gas. And <code>sync</code> did the same thing.</p>
<blockquote>
<p>Life could be just that easy, I hope.</p>
</blockquote>
<p>This mechanism works fine for a very very long time. Until my colleague tell me that he failed to buy the summit discount ticket using sync, the transaction run out gas. I was confused, it’s a simple contract, simple as <code>Hello World</code>:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">buyXNodeTicket</span>(<span class="params">uint quantity</span>) <span class="title">public</span> <span class="title">payable</span> <span class="title">returns</span>(<span class="params">bool</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">require</span>(msg.value / discountPrice == quantity, <span class="string">"Value sent must be a form of the discounted price"</span>);</span><br><span class="line">    <span class="built_in">require</span>(thorNodeContract.isX(msg.sender), <span class="string">"Message sender must be a X node"</span>);</span><br><span class="line">    </span><br><span class="line">    recipient.transfer(msg.value);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>It’s just checking the ticket amount and the transferred VET amount and send the value to the recipient immediately, just as easy as you can thought.Furthermore, I found a transaction that buying same amount of ticket, the gas used(29277) in the succeed transaction is lower than the failed transaction(30840)(Transaction gas is greater), that makes me feel confused very much, why does it run out of gas with more than needed gas.</p>
<p>After some minutes digging with the team, we found a possible clue. The gas cost of op_cod <code>CALL</code> with value transfer has at least a fixed gas cost of 9000, after the <code>CALL</code> operation finished the vm will return the left over gas. Total gas used for <code>CALL</code> is much lower than 9000 since there is no code to run for the recipient. I traced the transaction and got the <code>CALL</code> only cost no more than 1000 gas. But to make the transaction succeed, you need at least 8000 extra gas for it to make this step’s gas deduction succeed. So the trick failed since the evaluated gas is a small amount :(. But we upgraded it by:</p>
<div class="note info">
            <p><strong>Increase the evaluated gas by a fixed amount: 15000.</strong></p>
          </div>
<blockquote>
<p>EVM make the <code>CALL</code> with value transfer a fixed gas cost other than the total left over gas for reason, mainly for preventing attacks.</p>
</blockquote>

      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/dapp/" rel="tag"># dapp</a>
          
            <a href="/tags/wallet/" rel="tag"># wallet</a>
          
            <a href="/tags/sdk/" rel="tag"># sdk</a>
          
            <a href="/tags/gas/" rel="tag"># gas</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2019/05/16/Watch-The-Blockchain/" rel="next" title="Watch The Blockchain">
                <i class="fa fa-chevron-left"></i> Watch The Blockchain
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2019/05/25/Fee-Delegation-MPP-zh/" rel="prev" title="Fee Delegation - MPP(中文版)">
                Fee Delegation - MPP(中文版) <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>


  </div>


          </div>
          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <div class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">tony.li</p>
              <div class="site-description motion-element" itemprop="description"></div>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">6</span>
                    <span class="site-state-item-name">posts</span>
                  </a>
                </div>
              

              

              
                
                
                <div class="site-state-item site-state-tags">
                  
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">15</span>
                    <span class="site-state-item-name">tags</span>
                  
                </div>
              
            </nav>
          

          

          

          

          

          
          

          
            
          
          

        </div>
      </div>

      

      
        <div class="back-to-top">
          <i class="fa fa-arrow-up"></i>
          
            <span id="scrollpercent"><span>0</span>%</span>
          
        </div>
      

    </div>
  </aside>
  


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love" id="animate">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">tony.li</span>

  

  
</div>


  <div class="powered-by">Powered by <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme – <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a></div>




        








        
      </div>
    </footer>

    

    

    

    
  </div>

  

<script>
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  <script src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>


  


  <script src="/js/utils.js?v=7.1.1"></script>

  <script src="/js/motion.js?v=7.1.1"></script>



  
  


  <script src="/js/affix.js?v=7.1.1"></script>

  <script src="/js/schemes/pisces.js?v=7.1.1"></script>




  
  <script src="/js/scrollspy.js?v=7.1.1"></script>
<script src="/js/post-details.js?v=7.1.1"></script>



  


  <script src="/js/next-boot.js?v=7.1.1"></script>


  

  

  

  


  


  




  

  

  

  

  

  

  

  

  

  

  

  

  

  

</body>
</html>
